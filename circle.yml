machine:
  timezone: Asia/Tokyo
  environment:
    TERRAFORM_VERSION: 0.9.1
    PATH: $HOME/.local/bin:$PATH

dependencies:
  override:
    - |
      if [[ ! -f ~/.local/bin/aws ]]; then
        pip install awscli --user
      fi
      if [[ ! -f ~/.local/bin/terraform ]]; then
        mkdir -p ~/.local/bin
        cd ~/.local/bin
        wget "https://releases.hashicorp.com/terraform/${TERRAFORM_VERSION}/terraform_${TERRAFORM_VERSION}_linux_amd64.zip"
        unzip *.zip
        rm *.zip
      fi
  post:
    - aws configure set region ap-northeast-1
  cache_directories:
    - ~/.local/bin

test:
  pre:
    - |
      echo "--- test start ---"
      which aws
      which terraform
  override:
    - echo "testing..."
  post:
    - echo "--- test finished ---"

deployment:
  test:
    branch: master
    commands:
      - uname -a
  production:
    branch: release/prd
    commands:
      - uname -a
  staging:
    branch: release/stg
    commands:
      - uname -a
  development:
    branch: release/dev
    commands:
      - uname -a
