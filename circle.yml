machine:
  timezone: Asia/Tokyo
  environment:
    PATH: $HOME/.local/bin:$PATH
    AWS_DEFAULT_REGION: ap-northeast-1 
    TERRAFORM_VERSION: 0.9.1

dependencies:
  override:
    - |
      sudo pip install awscli
      if [[ ! -f ~/.local/bin/terraform ]]; then
        mkdir -p ~/.local/bin
        (
          cd ~/.local/bin
          wget "https://releases.hashicorp.com/terraform/${TERRAFORM_VERSION}/terraform_${TERRAFORM_VERSION}_linux_amd64.zip"
          unzip *.zip
          rm *.zip
        )
      fi
  cache_directories:
    - ~/.local/bin

test:
  pre:
    - echo "--- test start ---"
  override:
    - |
      echo "[TEST] AWS CLI is installed."
      which aws
    - |
      echo "[TEST] Terraform is installed."
      which terraform
    - |
      if [[ "${CIRCLE_BRANCH}" = "master" ]]; then
        true
      elif
        cd env/${CIRCLE_BRANCH}
        terraform remote config -backend=s3 -backend-config="bucket=${BUCKET_NAME}" -backend-config='key=${CIRCLE_BRANCH}/terraform.tfstate'
        terraform get -update
        terraform plan
      fi
  post:
    - echo "--- test finished ---"

deployment:
  master:
    branch: master
    commands:
      - uname -a
  env-proxy-prd:
    branch: release/env-proxy-prd
    commands:
      - |
        cd env/${CIRCLE_BRANCH}
        terraform get -update
        terraform apply
        terraform remote push
  env-proxy-stg:
    branch: release/env-proxy-stg
    commands:
      - |
        cd env/${CIRCLE_BRANCH}
        terraform get -update
        terraform apply
        terraform remote push
  env-infra-prd:
    branch: release/env-infra-prd
    commands:
      - |
        cd env/${CIRCLE_BRANCH}
        terraform get -update
        terraform apply
        terraform remote push
  env-infra-stg:
    branch: release/env-infra-stg
    commands:
      - |
        cd env/${CIRCLE_BRANCH}
        terraform get -update
        terraform apply
        terraform remote push
  env-website01-prd:
    branch: release/env-website01-prd
    commands:
      - |
        cd env/${CIRCLE_BRANCH}
        terraform get -update
        terraform apply
        terraform remote push
  env-website01-stg:
    branch: release/env-website01-stg
    commands:
      - |
        cd env/${CIRCLE_BRANCH}
        terraform get -update
        terraform apply
        terraform remote push
